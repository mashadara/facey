# Facey: Generate and manipulate faces

Facey performs user-guided generation of faces and morphs between them. There
are currently two main components of facey: the model finder GUI, and the
command-line facetool.

Facey is based on an implementation of the
[NVidia StyleGAN](https://github.com/NVlabs/stylegan) by Piotr Bialecki and
Thomas Viehmann available [here](https://github.com/lernapparat/lernapparat/blob/master/style_gan/pytorch_style_gan.ipynb).

## Concepts

The central data type in facey is the `.face` file, which contains information on
how to generate an image of a face.  `.face` files can be *developed* into jpg
images, and can be *interpolated* to produce morphs.  For example:
```
Alice.face --develop--> Alice.jpg

Alice.face, Bob.face --morph--> Alice_Bob_0.jpg, Alice_Bob_1.jpg, etc...
```

`.face` files are generated by *sampling* from a model, which describes the general
properties of a class of faces (eg blonde females).  Model files have the
extension `.model`.
```
Young_women.model --sample--> Alice.face, Beth.face, Carol.face, etc...
Old_men.model --sample--> Alan.face, Bob.face, etc...
```

`.model` files are created by a search done by the Model Search GUI (`modelfinder.py`).
The progress of an ongoing search is saved in a `.search` file.

## Usage

### Generating a morph

#### 1. Picking faces
The first step is to generate faces to be the start and end of the morph.  For now
this is a bit rough and uses modelfinder.py.  Launch modelfinder.py with `python modelfinder.py`

If you have a specific model you wish to use to generate the faces, load it
now with `File\New from Model...`.  This step is optional.  If you do not load a
model, the faces generated will be from the full StyleGAN range.

Next, sample the faces.  Do this by clicking "Do Sample."  This step can be slow,
especially if you do not have CUDA (Use CUDA box is grayed out).  You can control
the number of faces sampled by changing the Count field.

Once the faces are generated they will be displayed in the bottom centre box.
Scroll through these, clicking on any for more detail in the top right.  If you
find a face you wish to save, click on it so that it is shown in the top right
window, then click on `Face\Export Face...`, and save as a `.face` file.

If you wish to generate more faces you must change the "Sample seed" field to
a different number, or else the same set of faces will be returned.

#### 2. Morphing
This is currently command-line only.  If you have face files `Bob.face` and
`Alice.face`, run the following from the command line:
`python facetool.py face.interpolate w Bob.face Alice.face 20`
This will generate 20 images that morph from Bob to Alice in the current directory.
Images will be named Bob_Alice_w_00_0.0.jpg, Bob_Alice_w_01_0.05.jpg, etc.

`face.interpolate` has the following options:
```
facetool.py face.interpolate [--cpuonly] [--outdir=<path>] (w|x) <source.face> <dest.face> <n>

--cpuonly        Do not use GPU (ie use CPU only). Default is to use GPU if available.
--outdir=<path>  Save images to this output directory [default: current directory].
```
The `<n>` parameter controls the number of images.  The `(w|x)` parameter supplies
the mode of the interpolation, for more details see the StyleGAN paper.  `w` generally
gives the best results.  If you experience problems with some faces in the morph
appearing deformed or corrupted, try using `x` mode. This may negatively affect the morph
in other ways though.


### Generating a model
  1. Launch modelfinder.py with `python modelfinder.py`.
  2. Click "Do Sample" and wait. Images will appear in the bottom centre panel.
  3. Move any images which are similar to your desired face to the top panel.
     Do this by selecting the images with the mouse (multiple selection is possible
     with Ctrl) and clicking "Set good".  *Do not drag and drop to do this*.
     At first not many images will match your target, so start general. For example,
     if you are seeking a model for young brunette females, initially select only
     females, or only brunettes.  Aim to have at least 10 "good" samples.
  4. Click "Do Search" and wait. When done, the "Round" counter in the top left
     will increment and the images will disappear.  They can still be examined
     by changing the round in the top left panel.
  5. Repeat steps 2 to 4 until you are satisfied with the faces generated.  As
     the system learns what to generate it's possible to become more specific,
     narrowing down on a specific face type.  It's also possible to change the
     model 'mid-flight' by changing the faces chosen, though it may take some
     time for it to settle down to the new face type.
  6. At any time you can save specific faces or the model that generated the faces
     in a round.  To save a face, select it so it is displayed in the top right
     panel, then click "Face\Save As...".  To save a model, select a round from
     the round list that generated the faces you like, then click "Model\Export Model..."


## Installation
Optional: Install CUDA 10.0 by following [these instructions](https://developer.nvidia.com/cuda-10.0-download-archive). Although CUDA is not strictly required, it does speed up the tool considerably.
A modern compatible graphics card will be needed.

1. Install Miniconda following the instructions [here](https://conda.io/projects/conda/en/latest/user-guide/install/index.html).
2. (Not sure if needed?) Install Qt 5 framework.
3. Enter the Miniconda command prompt (varies by platform, see install instructions from step 1), and enter in turn:
   ```bash
   conda create -y -n facey python=3
   conda activate facey
   conda install -y docopt requests h5py pyqt=5

   # If using CUDA:
   conda install -y pytorch torchvision cudatoolkit=10.0 -c pytorch
   # If not using CUDA:
   conda install -y pytorch-cpu torchvision-cpu -c pytorch

   # For both CUDA and non-CUDA:
   pip install pyro-ppl
   ```
